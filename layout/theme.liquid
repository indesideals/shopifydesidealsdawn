{% comment %}
  DEVICE DETECTION & ROUTING SYSTEM
  This controller determines which layout to render based on device type
  Complete separation between mobile and desktop experiences
{% endcomment %}

{% assign device_param = request.url | split: 'device=' | last | split: '&' | first %}
{% assign force_mobile = false %}
{% assign force_desktop = false %}

{% if device_param == 'mobile' %}
  {% assign force_mobile = true %}
{% elsif device_param == 'desktop' %}
  {% assign force_desktop = true %}
{% endif %}

{% comment %} Check for mobile user agents {% endcomment %}
{% assign mobile_agents = 'Android,webOS,iPhone,iPad,iPod,BlackBerry,IEMobile,Opera Mini' | split: ',' %}
{% assign is_mobile_agent = false %}
{% for agent in mobile_agents %}
  {% if request.user_agent contains agent %}
    {% assign is_mobile_agent = true %}
    {% break %}
  {% endif %}
{% endfor %}

<!DOCTYPE html>
<html lang="{{ request.locale.iso_code }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="">
  <link rel="canonical" href="{{ canonical_url }}">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="{{ 'favicon.svg' | asset_url }}">
  <link rel="manifest" href="{{ 'site.webmanifest' | asset_url }}">
  
  <title>
    {{ page_title }}
    {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
    {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
    {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
  </title>

  {% if page_description %}
    <meta name="description" content="{{ page_description | escape }}">
  {% endif %}

  {{ content_for_header }}

  <!-- Load appropriate CSS based on device -->
  {% if force_mobile or is_mobile_agent %}
    <!-- Mobile CSS -->
    {{ 'base.css' | asset_url | stylesheet_tag }}
    {{ 'mobile.css' | asset_url | stylesheet_tag }}
  {% else %}
    <!-- Desktop CSS -->
    {{ 'base.css' | asset_url | stylesheet_tag }}
    {{ 'desktop.css' | asset_url | stylesheet_tag }}
  {% endif %}

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Critical CSS for immediate rendering */
    :root {
      --color-primary: #1a1a1a;
      --color-secondary: #ffffff;
      --color-accent: #6366f1;
      --color-accent-dark: #4f46e5;
      --color-purple: #8b5cf6;
      --color-purple-dark: #7c3aed;
      --color-blue: #3b82f6;
      --color-blue-dark: #1d4ed8;
      --color-text: #2c2c2c;
      --color-text-light: #6b7280;
      --color-border: #e5e7eb;
      --color-background: #fafafa;
      --color-gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --color-gradient-secondary: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      --color-gradient-accent: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      --color-gradient-subtle: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --color-gradient-dark: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-family-secondary: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-large: 0 10px 25px rgba(0, 0, 0, 0.15);
      --border-radius: 8px;
      --border-radius-large: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Viewport-aware sizing */
      --container-max-width: min(1200px, 90vw);
      --container-padding: clamp(1rem, 3vw, 2rem);
      --section-padding: clamp(2rem, 5vw, 4rem);
      --font-size-base: clamp(14px, 1vw, 16px);
      --font-size-large: clamp(18px, 1.5vw, 24px);
      --font-size-xl: clamp(24px, 2.5vw, 32px);
      --font-size-2xl: clamp(32px, 3.5vw, 48px);
      --font-size-3xl: clamp(48px, 5vw, 64px);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      line-height: 1.6;
      color: var(--color-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Desktop Top Banner - Elegant Scrolling Marquee */
    .desktop-top-banner {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      padding: 0.75rem 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1001;
      overflow: hidden;
      display: flex;
      align-items: center;
    }

    .desktop-banner-marquee {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
    }

    .desktop-marquee-content {
      display: inline-flex;
      align-items: center;
      animation: scroll 200s linear infinite;
      white-space: nowrap;
    }

    .desktop-marquee-content span {
      margin-right: 60px;
      display: inline-block;
      font-weight: 500;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
      opacity: 0.95;
      transition: opacity 0.3s ease;
    }

    .desktop-marquee-content span:hover {
      opacity: 1;
    }

    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    /* Desktop Header */
    .desktop-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: var(--color-primary);
      padding: 0.7rem 0;
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: var(--shadow-subtle);
      border-bottom: 1px solid var(--color-border);
    }

    .desktop-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: var(--container-max-width);
      margin: 0 auto;
      padding: 0 var(--container-padding);
      width: 100%;
    }

    .desktop-header-left {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .desktop-menu-toggle {
      background: none;
      border: 2px solid var(--color-border);
      cursor: pointer;
      color: var(--color-primary);
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
      margin-right: 0.7rem;
    }

    .desktop-menu-toggle:hover {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .desktop-header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 0.35rem 0;
    }

    .desktop-logo a {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--color-primary);
      text-decoration: none;
      letter-spacing: 1px;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .desktop-logo a:hover {
      color: var(--color-accent);
    }

    .desktop-logo img {
      max-height: 80px;
      width: auto;
      transition: var(--transition);
    }

    .desktop-logo a:hover img {
      transform: translateY(-3px);
      filter: drop-shadow(0 3px 8px rgba(99, 102, 241, 0.2));
    }

    .desktop-header-right {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 1rem;
    }

    /* Search Container */
    .desktop-search-container {
      display: flex;
      align-items: center;
      position: relative;
    }

    .desktop-search-toggle {
      background: none;
      border: none;
      color: var(--color-primary);
      cursor: pointer;
      transition: var(--transition);
      padding: 0.35rem;
      border-radius: var(--border-radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.65rem;
      font-weight: 500;
    }

    .desktop-search-toggle:hover {
      color: var(--color-accent);
      background: rgba(99, 102, 241, 0.1);
      transform: translateY(-2px);
    }

    .desktop-search-toggle svg {
      width: 20px;
      height: 20px;
    }

    .desktop-header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .desktop-header-actions a {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--color-primary);
      text-decoration: none;
      font-size: 0.65rem;
      font-weight: 500;
      gap: 0.35rem;
      transition: var(--transition);
      padding: 0.35rem;
      border-radius: var(--border-radius);
    }

    .desktop-header-actions a:hover {
      color: var(--color-accent);
      background: rgba(99, 102, 241, 0.1);
      transform: translateY(-2px);
    }

    .desktop-header-actions svg {
      width: 20px;
      height: 20px;
    }

    /* Burger Menu */
    .desktop-burger-menu {
      position: fixed;
      top: 0;
      left: -20%;
      width: 20%;
      height: 100vh;
      background: white;
      box-shadow: var(--shadow-large);
      z-index: 1003;
      transition: left 0.3s ease;
      overflow-y: auto;
    }

    .desktop-burger-menu.active {
      left: 0;
    }

    .desktop-burger-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1002;
      display: none;
    }

    .desktop-burger-menu-overlay.active {
      display: block;
    }

    .desktop-burger-menu-header {
      padding: 2rem 1.5rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .desktop-burger-menu-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--color-primary);
      padding: 0.5rem;
      border-radius: 50%;
      transition: var(--transition);
    }

    .desktop-burger-menu-close:hover {
      background: var(--color-bg-light);
    }

    .desktop-burger-menu-nav {
      padding: 1.5rem;
    }

    .desktop-burger-menu-nav a {
      display: block;
      padding: 1rem;
      color: var(--color-primary);
      text-decoration: none;
      font-weight: 500;
      border-radius: var(--border-radius);
      transition: var(--transition);
      margin-bottom: 0.5rem;
    }

    .desktop-burger-menu-nav a:hover {
      background: var(--color-bg-light);
      color: var(--color-accent);
    }

    /* Main Content */
    main {
      flex: 1;
      padding-top: 120px; /* Reduced space for smaller header + banner */
    }

    /* Mobile styles */
    @media (max-width: 768px) {
      .desktop-header,
      .desktop-top-banner {
        display: none;
      }
      
      main {
        padding-top: 0;
      }
    }
  </style>

</head>

<body class="{% if force_mobile or is_mobile_agent %}mobile-experience{% else %}desktop-experience{% endif %}" data-theme-type="{% if force_mobile or is_mobile_agent %}mobile{% else %}desktop{% endif %}">

  <!-- Render appropriate header and content based on device -->
  {% if force_mobile or is_mobile_agent %}
    <!-- Mobile Layout -->
    <div class="mobile-top-banner">
      <div class="mobile-banner-content">
        üöö FREE SHIPPING ‚Çπ299+ | üí≥ COD | üî• 40% OFF
      </div>
    </div>
    
    <header class="mobile-header">
      <!-- Mobile header content will go here -->
      <div class="mobile-header-content">
        <h1>Mobile View</h1>
      </div>
    </header>
    
  {% else %}
    <!-- Desktop Layout -->
    <div class="desktop-top-banner">
      <div class="desktop-banner-marquee">
        <div class="desktop-marquee-content">
          <span>üöö FREE SHIPPING ABOVE ‚Çπ299</span>
          <span>üí≥ CASH ON DELIVERY AVAILABLE</span>
          <span>üî• 40% OFF SITE WIDE</span>
          <span>‚ú® PREMIUM QUALITY GUARANTEED</span>
          <span>üöö FREE SHIPPING ABOVE ‚Çπ299</span>
          <span>üí≥ CASH ON DELIVERY AVAILABLE</span>
          <span>üî• 40% OFF SITE WIDE</span>
          <span>‚ú® PREMIUM QUALITY GUARANTEED</span>
          <span>üöö FREE SHIPPING ABOVE ‚Çπ299</span>
          <span>üí≥ CASH ON DELIVERY AVAILABLE</span>
          <span>üî• 40% OFF SITE WIDE</span>
          <span>‚ú® PREMIUM QUALITY GUARANTEED</span>
          <span>üöö FREE SHIPPING ABOVE ‚Çπ299</span>
          <span>üí≥ CASH ON DELIVERY AVAILABLE</span>
          <span>üî• 40% OFF SITE WIDE</span>
          <span>‚ú® PREMIUM QUALITY GUARANTEED</span>
          <span>üöö FREE SHIPPING ABOVE ‚Çπ299</span>
          <span>üí≥ CASH ON DELIVERY AVAILABLE</span>
          <span>üî• 40% OFF SITE WIDE</span>
          <span>‚ú® PREMIUM QUALITY GUARANTEED</span>
          <span>üöö FREE SHIPPING ABOVE ‚Çπ299</span>
          <span>üí≥ CASH ON DELIVERY AVAILABLE</span>
          <span>üî• 40% OFF SITE WIDE</span>
          <span>‚ú® PREMIUM QUALITY GUARANTEED</span>
        </div>
      </div>
    </div>

    <header class="desktop-header">
      <div class="desktop-header-content">
        <div class="desktop-header-left">
          <button class="desktop-menu-toggle" onclick="toggleBurgerMenu()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="12" x2="21" y2="12"/>
              <line x1="3" y1="6" x2="21" y2="6"/>
              <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
          </button>
        </div>
        
        <div class="desktop-header-center">
          <div class="desktop-logo">
            <a href="/">
              {% if settings.logo %}
                <img src="{{ settings.logo | image_url: width: 600 }}" alt="{{ shop.name }}" loading="eager">
              {% else %}
                <span>DESI DEALS</span>
              {% endif %}
            </a>
          </div>
        </div>
        
        <div class="desktop-header-right">
          <div class="desktop-search-container">
            <button class="desktop-search-toggle" onclick="toggleSearch()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21L16.65 16.65"/>
              </svg>
              <span>Search</span>
            </button>
          </div>
          
          <div class="desktop-header-actions">
            <a href="/account" title="Account">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              <span>Account</span>
            </a>
            <a href="/pages/favorites" title="Wishlist">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              <span>Wishlist</span>
            </a>
            <a href="/cart" title="Cart">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 22c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1z"/>
                <path d="M20 22c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1z"/>
                <path d="M1 1h4l2.68 13.39c.09.46.46.78.92.78h9.4c.46 0 .83-.32.92-.78L23 6H6"/>
              </svg>
              <span>Cart</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Burger Menu -->
    <div class="desktop-burger-menu-overlay" id="burgerOverlay" onclick="closeBurgerMenu()"></div>
    <div class="desktop-burger-menu" id="burgerMenu">
      <div class="desktop-burger-menu-header">
        <h3>Menu</h3>
        <button class="desktop-burger-menu-close" onclick="closeBurgerMenu()">√ó</button>
      </div>
      <nav class="desktop-burger-menu-nav">
        <a href="/">üè† Home</a>
        <a href="/collections/all">üõçÔ∏è All Products</a>
        <a href="/pages/about-us">‚ÑπÔ∏è About Us</a>
        <a href="/pages/contact">üìû Contact</a>
        <a href="/pages/favorites">üíñ Wishlist</a>
        <a href="/pages/shipping-and-returns-policy">üöö Shipping & Returns</a>
        <a href="/account">üë§ {% if customer %}My Account{% else %}Login{% endif %}</a>
      </nav>
    </div>
  {% endif %}

  <!-- Main Content -->
  <main>
    {{ content_for_layout }}
  </main>

  <!-- Footer -->
  {% section 'footer' %}

  <!-- Load appropriate JavaScript based on device -->
  {% if force_mobile or is_mobile_agent %}
    <!-- Mobile JS -->
    <script src="{{ 'mobile.js' | asset_url }}" defer></script>
  {% else %}
    <!-- Desktop JS -->
    <script src="{{ 'desktop.js' | asset_url }}" defer></script>
  {% endif %}

  <script>
    // Desktop Header Functionality
    function toggleSearch() {
      console.log('toggleSearch function called from theme.liquid');
      // Let desktop.js handle the search functionality
      if (window.toggleSearch) {
        window.toggleSearch();
      } else {
        console.log('window.toggleSearch not available');
      }
    }

    function toggleBurgerMenu() {
      const burgerMenu = document.getElementById('burgerMenu');
      const burgerOverlay = document.getElementById('burgerOverlay');
      
      burgerMenu.classList.add('active');
      burgerOverlay.classList.add('active');
    }

    function closeBurgerMenu() {
      const burgerMenu = document.getElementById('burgerMenu');
      const burgerOverlay = document.getElementById('burgerOverlay');
      
      burgerMenu.classList.remove('active');
      burgerOverlay.classList.remove('active');
    }

    // Close burger menu on escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeBurgerMenu();
      }
    });
  </script>

</body>
</html>
